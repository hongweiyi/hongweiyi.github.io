<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> BTrace 使用实践 · 小e的笔记</title><meta name="description" content="最近在做性能优化项目时，发现 RPC 框架调用极个别请求在路由过程非常耗时。对于这种极个别的问题要定位起来还是比较棘手的，如果性能问题可以稳定复现的还可以一步步打点缩小范围，但我这个是千分之一的出现概率，需要大规模日志打点才能够准确找到耗时的地方。如何搞呢，只能网上找找有没有更好的办法了，在网上看资料时，突然看到毕玄的文章提到可以用 btrace 定位这样的问题，现学现卖了一把。

1. 基本使用直接下载安装 github release 即可。

添加 BTRACE_HOME 到环境变量
运行：bin/btrace &amp;lt;PID&amp;gt; &amp;lt;trace_script&amp;gt;
编译：bin/btracec &amp;lt;trace_script&amp;gt;


btrace 不需要预先编译脚本。
&lt;"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="http://weibo.com/1674333040" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://twitter.com/hongwei89" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">BTrace 使用实践</h1><div class="post-meta"><div class="post-time">Jan 13, 2016 | [<a class="tag-link" href="/tags/BTrace/">BTrace</a>, <a class="tag-link" href="/tags/Java/">Java</a>]</div></div><div class="post-content"><p>最近在做性能优化项目时，发现 RPC 框架调用极个别请求在路由过程非常耗时。对于这种极个别的问题要定位起来还是比较棘手的，如果性能问题可以稳定复现的还可以一步步打点缩小范围，但我这个是千分之一的出现概率，需要大规模日志打点才能够准确找到耗时的地方。如何搞呢，只能网上找找有没有更好的办法了，在网上看资料时，突然看到毕玄的文章提到可以用 btrace 定位这样的问题，现学现卖了一把。</p>
<a id="more"></a>
<h3 id="1-_基本使用">1. 基本使用</h3><p>直接下载安装 <a href="https://github.com/jbachorik/btrace/releases/tag/v1.3.4" target="_blank" rel="external">github release</a> 即可。</p>
<ul>
<li>添加 <code>BTRACE_HOME</code> 到环境变量</li>
<li>运行：<code>bin/btrace &lt;PID&gt; &lt;trace_script&gt;</code></li>
<li>编译：<code>bin/btracec &lt;trace_script&gt;</code></li>
</ul>
<blockquote>
<p>btrace 不需要预先编译脚本。</p>
</blockquote>
<h3 id="2-_我的脚本">2. 我的脚本</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以不用 package</span></span><br><span class="line"><span class="keyword">package</span> com.sun.btrace.scripts;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* BTrace Script Template */</span></span><br><span class="line"><span class="keyword">import</span> com.sun.btrace.annotations.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sun.btrace.BTraceUtils.*;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@BTrace</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileScript</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@TLS</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> startTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// com.alipay.sofa.rpc.process</span></span><br><span class="line">    <span class="annotation">@OnMethod</span>(clazz = <span class="string">"/com\\.hongweiyi\\.package\\.name\\..+/"</span>, method = <span class="string">"/.+/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        startTime = timeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">    <span class="annotation">@OnMethod</span>(clazz = <span class="string">"/com\\.hongweiyi\\.package\\.name\\..+/"</span>, method = <span class="string">"/.+/"</span>, location = <span class="annotation">@Location</span>(Kind.RETURN))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> cost = timeMillis() - startTime;</span><br><span class="line">        <span class="keyword">if</span> (cost &gt; <span class="number">3</span>) &#123;</span><br><span class="line">            print(strcat(strcat(strcat(strcat(name(probeClass()), <span class="string">"."</span>), probeMethod()), <span class="string">":"</span>), str(probeLine())));</span><br><span class="line">            print(<span class="string">"  ["</span>);</span><br><span class="line">            print(strcat(<span class="string">"Time taken : "</span>, str(timeMillis() - startTime)));</span><br><span class="line">            println(<span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-_使用实例">3. 使用实例</h3><p>正常使用：启动程序，拿到 PID，运行 <code>bin/btrace PID ProfileScript.java</code>，在脚本目录会出现 <code>ProfileScript.xxx.btrace</code> 的输出日志，可以直接通过这个日志定位问题。</p>
<p>但是我的程序运行后不断抛 <code>java.lang.NoClassDefFoundError: ProfileScript</code> 异常。想到我的程序比较特殊，是运行在 OSGi 之上的，在网上搜到 btrace 在 glassfish 上运行同样有这样的问题。</p>
<p>如果需要将 btrace 运行在 OSGi 程序上，其中一个解决方案是配置 OSGi 的 bootdelegation：</p>
<p><code>org.osgi.framework.bootdelegation = com.sun.btrace,com.sun.btrace.*</code></p>
<blockquote>
<p>注意：这个时候建议将 btrace 的 package 和 btrace 的设置成一样，这样 bootdelegation 才能生效</p>
</blockquote>
<p>之后运行：</p>
<p><code>btrace PID /home/admin/btrace/com/sun/btrace/scripts/ProfileScript.java</code></p>
<p>不过，由于运行 btrace 的时候 OSGi 已经起来了，如果需要跟踪 OSGi 启动过程的话，可以通过 javaagent 来配置 btrace 脚本：</p>
<p><code>-javaagent:/home/admin/btrace/build/btrace-agent.jar=script=/home/admin/btrace/com/sun/btrace/scripts/ProfileScript.class</code></p>
<blockquote>
<p>注意：javaagent 的方式配置需要编译 btrace 脚本，不能直接使用 java 文件。编译命令 <code>bin/btracec com/sun/btrace/ProfileScript.java</code></p>
</blockquote>
<h3 id="4-_btrace_优化小结">4. btrace 优化小结</h3><p>如果 <code>@OnMethod(clazz)</code> 设置得比较准确的话，还是可以很快的定位一些优化点。优化了一些并发 Map 操作，性能提升 5%，发现了一个历史大坑，性能提升 90%。这个历史大坑也就是导致极个别请求耗时较长的原因。</p>
<p>我在压测过程中，YGC 比较频繁，这样会导致会出现很多不必要的结果。如果实在没有头绪了，建议把 <code>@OnMethod(clazz)</code> 设置的范围比较大，扫所有的的类，待拿到结果之后，排除掉一些噪音后可以看到一些不错的结果。运行：</p>
<p><code>cat ProfileScript.btrace | awk &#39;{print $1}&#39; | sort | uniq -c | grep -v &#39;1 &#39; | grep -v &#39;2 &#39; | sort -k 2</code></p>
<blockquote>
<p>不要忽略任何一个可疑的问题，极个别耗时长的请求完全可以拖垮整个系统</p>
</blockquote>
<h3 id="5-_资料">5. 资料</h3><ul>
<li><a href="http://bluedavy.me/?p=334" target="_blank" rel="external">NFS-RPC框架优化过程</a></li>
<li><a href="http://blog.csdn.net/wildandfly/article/details/21107661" target="_blank" rel="external">BTrace简介及使用</a></li>
<li><a href="https://blogs.oracle.com/nishigaya/entry/btrace_with_glassfish_v3" target="_blank" rel="external">Running BTrace custom script with GlassFish V3</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a class="prev"></a><a href="/2016/01/a-summary-of-2015/" class="next">下一篇</a></div><div data-thread-key="2016/01/btrace-practice/" data-title="BTrace 使用实践" data-url="http://hongweiyi.com/2016/01/btrace-practice/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"yihongwei"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-66911097-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>